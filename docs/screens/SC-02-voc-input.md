# SC-02 VOC 입력 화면

## 1. 화면 개요

### 1.1 목적
VOC 접수자가 최종 사용자로부터 인입받은 VOC(Voice of Customer)를 시스템에 등록하는 화면

### 1.2 관련 요구사항
- FR-101: VOC 접수자는 최종 사용자의 VOC를 시스템에 입력할 수 있다
- FR-102: 최종 사용자 이메일은 필수 입력 항목이다
- FR-103: VOC 입력 완료 시 "VOC 입력이 완료되었습니다" 팝업을 노출한다
- FR-104: VOC 카테고리는 AI가 자동 분류한다 (접수자 선택 없음)
- FR-105: VOC 접수 완료 시 고유 접수번호(Ticket ID)를 발급하여 노출한다
- FR-106: VOC 접수 완료 시 최종 사용자 이메일로 접수 확인 메일을 자동 발송한다
- FR-107: VOC 접수자는 입력 중 임시 저장할 수 있다 (선택사항)
- FR-151: VOC 입력 API는 Rate Limiting을 적용한다 (분당 10건 제한)
- FR-153: 모든 텍스트 입력은 XSS 방지를 위해 sanitization을 수행한다
- FR-154: 첨부파일은 MIME 타입 검증 및 확장자 화이트리스트 검사를 수행한다
- FR-155: ZIP 파일 업로드 시 내부 파일 검사를 수행한다

### 1.3 관련 이슈
- Issue: #2

---

## 2. 접근 권한

| 사용자 유형 | 접근 가능 여부 |
|------------|---------------|
| VOC 접수자 | 가능 |
| VOC 처리 담당자 | 가능 (선택사항) |
| 관리자 | 가능 |

---

## 3. 레이아웃 구조

```
┌─────────────────────────────────────────────────┐
│  Header: VOC 입력                                │
├─────────────────────────────────────────────────┤
│                                                 │
│  [최종 사용자 이메일 *]                          │
│  ┌────────────────────────────────────────┐    │
│  │ example@domain.com                     │    │
│  └────────────────────────────────────────┘    │
│                                                 │
│  [제목 *]                                       │
│  ┌────────────────────────────────────────┐    │
│  │ VOC 제목을 입력하세요                   │    │
│  └────────────────────────────────────────┘    │
│                                                 │
│  [내용 *]                                       │
│  ┌────────────────────────────────────────┐    │
│  │ VOC 상세 내용을 입력하세요              │    │
│  │                                        │    │
│  │                                        │    │
│  │                                        │    │
│  └────────────────────────────────────────┘    │
│                                                 │
│  [발생 시간]                                    │
│  ┌────────────────────────────────────────┐    │
│  │ 2026-01-23 14:30                       │    │
│  └────────────────────────────────────────┘    │
│                                                 │
│  [계정 ID]                                      │
│  ┌────────────────────────────────────────┐    │
│  │ user123                                │    │
│  └────────────────────────────────────────┘    │
│                                                 │
│  [첨부파일]                                     │
│  ┌────────────────────────────────────────┐    │
│  │  [파일 선택]                            │    │
│  │                                        │    │
│  │  • screenshot.png (2.5MB) [삭제]       │    │
│  │  • error.log (1.2MB) [삭제]            │    │
│  │                                        │    │
│  │  2 / 5개 파일 (3.7MB / 30MB)           │    │
│  └────────────────────────────────────────┘    │
│                                                 │
│  [임시 저장]              [제출]                │
│                                                 │
└─────────────────────────────────────────────────┘
```

---

## 4. UI 요소 목록

### 4.1 입력 필드

| 필드명 | 필드 타입 | 필수 여부 | 설명 | 제약사항 |
|--------|----------|----------|------|----------|
| 최종 사용자 이메일 | text (email) | 필수 | 최종 사용자 연락처 | 이메일 형식 검증 |
| 제목 | text | 필수 | VOC 제목 | 최대 200자 |
| 내용 | textarea | 필수 | VOC 상세 내용 | 최대 5,000자 |
| 발생 시간 | datetime-local | 선택 | 문제 발생 시점 (로그 검색 기준) | 미래 시간 입력 불가 |
| 계정 ID | text | 선택 | 최종 사용자 서비스 계정 ID (로그 검색 기준) | 최대 100자 |
| 첨부파일 | file (multiple) | 선택 | 스크린샷, 로그 등 | 첨부파일 제약사항 참조 |

### 4.2 첨부파일 제약사항

| 항목 | 제한 | 설명 |
|------|------|------|
| 최대 용량 | 파일당 10MB, 총 30MB | 용량 초과 시 업로드 차단 |
| 허용 확장자 | jpg, png, gif, pdf, txt, log, zip | 화이트리스트 방식 검증 |
| 최대 개수 | 5개 | 개수 초과 시 업로드 차단 |
| 보안 검사 | 바이러스 스캔 수행 | 업로드 시 MIME 타입 검증 및 바이러스 스캔 |
| ZIP 파일 검사 | 내부 파일 검사 | ZIP 내부 파일도 확장자 및 용량 검증 |

### 4.3 버튼

| 버튼명 | 기능 | 활성화 조건 |
|--------|------|------------|
| 임시 저장 | 입력 중 데이터를 임시 저장 (선택사항) | 항상 활성화 |
| 제출 | VOC 접수 완료 및 Ticket ID 발급 | 필수 필드 입력 완료 시 |

---

## 5. 사용자 액션 및 이벤트

### 5.1 파일 업로드

```
사용자 액션: 파일 선택 버튼 클릭 → 파일 선택 다이얼로그 오픈
            ↓
시스템 검증: 1. 파일 개수 검증 (최대 5개)
            2. 파일 확장자 검증 (화이트리스트)
            3. 파일 용량 검증 (개별 10MB, 총 30MB)
            4. MIME 타입 검증
            5. ZIP 파일인 경우 내부 파일 검증
            6. 바이러스 스캔 (비동기)
            ↓
검증 성공: 파일 목록에 추가 표시 (파일명, 용량, 삭제 버튼)
검증 실패: 에러 메시지 표시 및 업로드 차단
```

### 5.2 임시 저장 (선택사항)

```
사용자 액션: 임시 저장 버튼 클릭
            ↓
시스템 처리: 1. 현재 입력 데이터를 LocalStorage 또는 서버에 저장
            2. "임시 저장되었습니다" 토스트 메시지 표시
            ↓
재접속 시: 임시 저장 데이터 복원 여부 팝업 표시
```

### 5.3 VOC 제출

```
사용자 액션: 제출 버튼 클릭
            ↓
클라이언트 검증: 1. 필수 필드 입력 여부 확인
                2. 이메일 형식 검증
                3. 발생 시간 미래 시간 여부 확인
                4. 텍스트 길이 제한 확인
                ↓
서버 제출: API 호출 (POST /api/voc)
            ↓
서버 처리: 1. Rate Limiting 검증 (분당 10건)
          2. XSS Sanitization 수행
          3. 첨부파일 보안 검증
          4. DB 저장 (상태: '접수')
          5. Ticket ID 발급 (형식: VOC-YYYYMMDD-XXXXX)
          6. 최종 사용자 이메일 발송 (비동기)
          7. AI 분석 작업 큐에 등록 (비동기)
            ↓
성공 응답: 1. Ticket ID 반환
          2. "VOC 입력이 완료되었습니다" 팝업 표시
          3. Ticket ID 표시
          4. 폼 초기화
          5. 임시 저장 데이터 삭제
```

---

## 6. 유효성 검사

### 6.1 클라이언트 검증 (실시간)

| 필드 | 검증 규칙 | 에러 메시지 |
|------|----------|------------|
| 최종 사용자 이메일 | 1. 필수 입력<br>2. 이메일 형식 (RFC 5322) | "이메일을 입력해주세요"<br>"올바른 이메일 형식이 아닙니다" |
| 제목 | 1. 필수 입력<br>2. 최대 200자 | "제목을 입력해주세요"<br>"제목은 최대 200자까지 입력 가능합니다" |
| 내용 | 1. 필수 입력<br>2. 최대 5,000자 | "내용을 입력해주세요"<br>"내용은 최대 5,000자까지 입력 가능합니다" |
| 발생 시간 | 미래 시간 입력 불가 | "발생 시간은 현재 시간 이전이어야 합니다" |
| 계정 ID | 최대 100자 | "계정 ID는 최대 100자까지 입력 가능합니다" |
| 첨부파일 | 1. 최대 5개<br>2. 파일당 10MB, 총 30MB<br>3. 허용 확장자만 업로드<br>4. MIME 타입 검증 | "최대 5개까지 업로드 가능합니다"<br>"파일 용량이 초과되었습니다"<br>"허용되지 않는 파일 형식입니다"<br>"파일 타입이 올바르지 않습니다" |

### 6.2 서버 검증

| 검증 항목 | 검증 로직 | 실패 시 처리 |
|----------|----------|-------------|
| Rate Limiting | 동일 사용자 분당 10건 제한 | HTTP 429 (Too Many Requests) 반환 |
| XSS Sanitization | 모든 텍스트 입력값 sanitization | 악성 스크립트 제거 후 저장 |
| 첨부파일 보안 | 1. MIME 타입 재검증<br>2. 바이러스 스캔<br>3. ZIP 내부 파일 검사 | HTTP 400 (Bad Request) 반환 |
| 이메일 형식 | RFC 5322 준수 여부 | HTTP 400 (Bad Request) 반환 |
| 데이터 길이 | DB 컬럼 길이 제한 준수 | HTTP 400 (Bad Request) 반환 |

---

## 7. 에러 처리

### 7.1 클라이언트 에러

| 에러 시나리오 | 에러 메시지 | 처리 방법 |
|-------------|------------|----------|
| 필수 필드 미입력 | "필수 항목을 입력해주세요" | 해당 필드 하이라이트 및 포커스 이동 |
| 이메일 형식 오류 | "올바른 이메일 형식이 아닙니다" | 이메일 필드 하이라이트 |
| 파일 용량 초과 | "파일 용량이 초과되었습니다 (최대 10MB)" | 파일 업로드 차단 및 에러 메시지 표시 |
| 파일 개수 초과 | "최대 5개까지 업로드 가능합니다" | 파일 업로드 차단 및 에러 메시지 표시 |
| 허용되지 않는 확장자 | "허용되지 않는 파일 형식입니다 (jpg, png, gif, pdf, txt, log, zip)" | 파일 업로드 차단 및 에러 메시지 표시 |

### 7.2 서버 에러

| HTTP 상태 코드 | 에러 시나리오 | 에러 메시지 | 처리 방법 |
|---------------|-------------|------------|----------|
| 400 | 잘못된 요청 (유효성 검사 실패) | "입력 데이터가 올바르지 않습니다" | 서버 응답의 상세 메시지 표시 |
| 413 | 파일 용량 초과 | "업로드 파일 용량이 초과되었습니다" | 에러 메시지 표시 및 파일 제거 안내 |
| 429 | Rate Limiting 초과 | "요청이 너무 많습니다. 잠시 후 다시 시도해주세요" | 에러 메시지 표시 및 제출 버튼 비활성화 (1분) |
| 500 | 서버 내부 오류 | "서버 오류가 발생했습니다. 잠시 후 다시 시도해주세요" | 에러 메시지 표시 및 재시도 안내 |
| 503 | 서비스 일시 중단 | "서비스가 일시적으로 중단되었습니다" | 에러 메시지 표시 및 관리자 연락 안내 |

### 7.3 네트워크 에러

| 에러 시나리오 | 에러 메시지 | 처리 방법 |
|-------------|------------|----------|
| 네트워크 연결 실패 | "네트워크 연결을 확인해주세요" | 재시도 버튼 표시 |
| 요청 타임아웃 | "요청 시간이 초과되었습니다. 다시 시도해주세요" | 재시도 버튼 표시 |

---

## 8. 연관 API

### 8.1 VOC 제출 API

```
POST /api/voc
Content-Type: multipart/form-data

Request Body:
{
  "email": "user@example.com",          // 필수
  "title": "VOC 제목",                   // 필수
  "content": "VOC 상세 내용",            // 필수
  "occurredAt": "2026-01-23T14:30:00",  // 선택
  "accountId": "user123",               // 선택
  "attachments": [File, File, ...]      // 선택 (최대 5개)
}

Response (성공):
HTTP 201 Created
{
  "success": true,
  "data": {
    "ticketId": "VOC-20260123-00001",
    "status": "접수",
    "createdAt": "2026-01-23T14:35:00Z",
    "emailSent": true
  },
  "message": "VOC 입력이 완료되었습니다"
}

Response (실패 - Rate Limiting):
HTTP 429 Too Many Requests
{
  "success": false,
  "error": {
    "code": "RATE_LIMIT_EXCEEDED",
    "message": "요청이 너무 많습니다. 잠시 후 다시 시도해주세요",
    "retryAfter": 60
  }
}

Response (실패 - 유효성 검사):
HTTP 400 Bad Request
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "입력 데이터가 올바르지 않습니다",
    "details": [
      {
        "field": "email",
        "message": "올바른 이메일 형식이 아닙니다"
      }
    ]
  }
}
```

### 8.2 파일 업로드 검증 API (선택사항)

```
POST /api/voc/attachments/validate
Content-Type: multipart/form-data

Request Body:
{
  "file": File
}

Response (성공):
HTTP 200 OK
{
  "success": true,
  "data": {
    "valid": true,
    "fileName": "screenshot.png",
    "fileSize": 2621440,
    "mimeType": "image/png"
  }
}

Response (실패):
HTTP 400 Bad Request
{
  "success": false,
  "error": {
    "code": "INVALID_FILE",
    "message": "허용되지 않는 파일 형식입니다",
    "details": {
      "allowedExtensions": ["jpg", "png", "gif", "pdf", "txt", "log", "zip"]
    }
  }
}
```

### 8.3 임시 저장 API (선택사항)

```
POST /api/voc/drafts
Content-Type: application/json

Request Body:
{
  "email": "user@example.com",
  "title": "VOC 제목",
  "content": "VOC 상세 내용",
  "occurredAt": "2026-01-23T14:30:00",
  "accountId": "user123"
}

Response (성공):
HTTP 200 OK
{
  "success": true,
  "data": {
    "draftId": "draft-uuid",
    "savedAt": "2026-01-23T14:32:00Z"
  },
  "message": "임시 저장되었습니다"
}
```

```
GET /api/voc/drafts/:draftId

Response (성공):
HTTP 200 OK
{
  "success": true,
  "data": {
    "email": "user@example.com",
    "title": "VOC 제목",
    "content": "VOC 상세 내용",
    "occurredAt": "2026-01-23T14:30:00",
    "accountId": "user123",
    "savedAt": "2026-01-23T14:32:00Z"
  }
}
```

---

## 9. 화면 전환

### 9.1 진입 경로

| 이전 화면 | 전환 조건 |
|----------|----------|
| SC-01 로그인 화면 | 로그인 성공 후 메인 네비게이션에서 "VOC 입력" 선택 |
| SC-03 VOC 상태 조회 화면 | 네비게이션에서 "VOC 입력" 선택 |

### 9.2 이탈 경로

| 다음 화면 | 전환 조건 |
|----------|----------|
| 현재 화면 유지 | VOC 제출 성공 후 팝업 닫기 (폼 초기화) |
| SC-03 VOC 상태 조회 화면 | VOC 제출 성공 팝업에서 "상태 조회" 버튼 클릭 (선택사항) |
| SC-06 VOC 상세 화면 | VOC 제출 성공 팝업에서 "상세 보기" 버튼 클릭 (처리 담당자만, 선택사항) |

### 9.3 VOC 제출 성공 팝업

```
┌─────────────────────────────────────────┐
│  VOC 입력이 완료되었습니다               │
├─────────────────────────────────────────┤
│                                         │
│  접수번호: VOC-20260123-00001           │
│                                         │
│  최종 사용자 이메일로 접수 확인         │
│  메일이 발송되었습니다.                 │
│                                         │
│  AI 분석이 완료되면 이메일로            │
│  알림을 보내드립니다.                   │
│                                         │
│          [확인]        [상태 조회]      │
│                                         │
└─────────────────────────────────────────┘
```

---

## 10. 접근성 (Accessibility)

### 10.1 키보드 네비게이션

| 키 | 동작 |
|----|------|
| Tab | 다음 입력 필드로 포커스 이동 |
| Shift + Tab | 이전 입력 필드로 포커스 이동 |
| Enter | 제출 버튼 활성화 (포커스 시) |
| Esc | 팝업 닫기 |

### 10.2 ARIA 속성

| 요소 | ARIA 속성 | 값 |
|------|----------|-----|
| 필수 필드 | aria-required | true |
| 에러 메시지 | role | alert |
| 첨부파일 업로드 상태 | aria-live | polite |
| 제출 버튼 (로딩 중) | aria-busy | true |

### 10.3 스크린 리더 지원

- 필수 필드에 "필수 입력 항목입니다" 음성 안내
- 파일 업로드 시 "파일 업로드 중입니다" 음성 안내
- VOC 제출 성공 시 "VOC 입력이 완료되었습니다. 접수번호는 {ticketId}입니다" 음성 안내

---

## 11. 보안 고려사항

### 11.1 XSS 방지

- 모든 텍스트 입력값은 서버에서 sanitization 수행
- HTML 태그, JavaScript 코드 제거
- 화면 표시 시 escape 처리

### 11.2 첨부파일 보안

- MIME 타입 검증 (클라이언트 + 서버)
- 확장자 화이트리스트 방식 검증
- 바이러스 스캔 (ClamAV 등)
- ZIP 파일 내부 검사 (Zip Bomb 방지)

### 11.3 Rate Limiting

- 동일 사용자(로그인 계정 기준) 분당 10건 제한
- IP 기반 Rate Limiting (선택사항)
- 제한 초과 시 1분간 제출 차단

### 11.4 개인정보 보호

- 최종 사용자 이메일 암호화 저장
- 첨부파일 안전한 스토리지에 저장 (S3, MinIO 등)
- 첨부파일 접근 권한 제어 (인증된 사용자만)

---

## 12. 성능 고려사항

### 12.1 응답 시간

- VOC 제출 API 응답 시간: 3초 이내
- Ticket ID 즉시 발급 (동기 처리)
- AI 분석은 비동기 처리 (백그라운드)
- 이메일 발송은 비동기 처리 (백그라운드)

### 12.2 파일 업로드 최적화

- 대용량 파일 업로드 시 프로그레스 바 표시
- 멀티파트 업로드 지원 (대용량 파일)
- 업로드 중 취소 기능

### 12.3 클라이언트 최적화

- 파일 업로드 전 클라이언트에서 용량/확장자 검증 (서버 부하 감소)
- 디바운싱 적용 (유효성 검사)
- 임시 저장 시 LocalStorage 활용 (서버 요청 최소화)

---

## 13. 테스트 시나리오

### 13.1 정상 케이스

| 시나리오 | 입력 데이터 | 기대 결과 |
|---------|-----------|----------|
| 필수 필드만 입력 | 이메일, 제목, 내용 | VOC 제출 성공, Ticket ID 발급 |
| 모든 필드 입력 | 이메일, 제목, 내용, 발생시간, 계정ID, 첨부파일 | VOC 제출 성공, Ticket ID 발급 |
| 첨부파일 5개 업로드 | 5개 파일 (총 30MB 이하) | VOC 제출 성공 |

### 13.2 예외 케이스

| 시나리오 | 입력 데이터 | 기대 결과 |
|---------|-----------|----------|
| 필수 필드 누락 | 이메일만 입력 | 클라이언트 검증 실패, 에러 메시지 표시 |
| 이메일 형식 오류 | 이메일: "invalid-email" | 클라이언트 검증 실패, 에러 메시지 표시 |
| 파일 용량 초과 | 파일: 15MB | 클라이언트 검증 실패, 업로드 차단 |
| 파일 개수 초과 | 파일: 6개 | 클라이언트 검증 실패, 업로드 차단 |
| 허용되지 않는 확장자 | 파일: .exe | 클라이언트 검증 실패, 업로드 차단 |
| Rate Limiting 초과 | 분당 11건 제출 | HTTP 429 응답, 에러 메시지 표시 |
| 미래 시간 입력 | 발생시간: 2026-01-24 (내일) | 클라이언트 검증 실패, 에러 메시지 표시 |

### 13.3 보안 테스트

| 시나리오 | 공격 벡터 | 기대 결과 |
|---------|----------|----------|
| XSS 공격 | 제목: `<script>alert('XSS')</script>` | Sanitization 수행, 스크립트 제거 |
| SQL Injection | 내용: `'; DROP TABLE voc; --` | Prepared Statement로 방어 |
| 악성 파일 업로드 | 파일: virus.exe | 확장자 검증 실패, 업로드 차단 |
| ZIP Bomb | 파일: zipbomb.zip | ZIP 내부 파일 검사, 업로드 차단 |

---

## 14. 개발 시 참고사항

### 14.1 프론트엔드 구현

- React + TypeScript 사용
- React Hook Form으로 폼 관리
- Zod로 유효성 검사 스키마 정의
- TanStack Query로 API 호출 관리
- ViewModel 패턴으로 비즈니스 로직 분리

### 14.2 백엔드 구현

- 비동기 처리: 작업 큐 (Redis Queue, BullMQ 등) 활용
- 파일 업로드: Multer 또는 FastAPI File Upload
- 바이러스 스캔: ClamAV 연동
- Rate Limiting: Redis + Express Rate Limit 또는 FastAPI Limiter
- XSS 방지: DOMPurify, sanitize-html 등

### 14.3 데이터베이스 스키마 (참고)

```sql
CREATE TABLE voc (
  id SERIAL PRIMARY KEY,
  ticket_id VARCHAR(50) UNIQUE NOT NULL,
  email VARCHAR(255) NOT NULL, -- 암호화 저장
  title VARCHAR(200) NOT NULL,
  content TEXT NOT NULL,
  occurred_at TIMESTAMP,
  account_id VARCHAR(100),
  status VARCHAR(20) DEFAULT '접수',
  created_by INTEGER REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE voc_attachments (
  id SERIAL PRIMARY KEY,
  voc_id INTEGER REFERENCES voc(id) ON DELETE CASCADE,
  file_name VARCHAR(255) NOT NULL,
  file_path VARCHAR(500) NOT NULL,
  file_size INTEGER NOT NULL,
  mime_type VARCHAR(100) NOT NULL,
  uploaded_at TIMESTAMP DEFAULT NOW()
);
```

---

## 15. 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|----------|--------|
| 1.0 | 2026-01-23 | 최초 작성 | Claude Code |
