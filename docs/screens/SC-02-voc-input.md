# SC-02 VOC 입력 화면

## 1. 화면 개요

### 1.1 목적
VOC 접수자가 최종 사용자로부터 인입받은 VOC(Voice of Customer)를 시스템에 등록하는 화면.
Email-First 게이트 패턴으로 고객 이력을 즉시 조회하고, AI가 카테고리와 우선순위를 자동 추천한다.

### 1.2 관련 요구사항
- FR-101: VOC 접수자는 최종 사용자의 VOC를 시스템에 입력할 수 있다
- FR-102: 최종 사용자 이메일은 필수 입력 항목이다
- FR-103: VOC 입력 완료 시 "VOC 입력이 완료되었습니다" 팝업을 노출한다
- FR-104: VOC 카테고리는 AI가 자동 추천한다 (접수자가 카드 UI로 선택/수정 가능)
- FR-105: VOC 접수 완료 시 고유 접수번호(Ticket ID)를 발급하여 노출한다
- FR-106: VOC 접수 완료 시 최종 사용자 이메일로 접수 확인 메일을 자동 발송한다
- FR-107: 임시저장은 PII 제외 localStorage 자동 저장 (2초 디바운스, 24시간 TTL)
- FR-108: AI가 제목+내용 기반으로 카테고리를 실시간 추천한다
- FR-109: AI가 카테고리+키워드 기반으로 우선순위를 자동 추천한다
- FR-110: 이메일 입력 즉시 고객의 미해결 VOC 이력을 자동 조회한다
- FR-151: VOC 입력 API는 Rate Limiting을 적용한다 (분당 10건 제한)
- FR-153: 모든 텍스트 입력은 XSS 방지를 위해 sanitization을 수행한다
- FR-154: 첨부파일은 MIME 타입 검증 및 확장자 화이트리스트 검사를 수행한다

### 1.3 관련 이슈
- Issue: #2

---

## 2. 접근 권한

| 사용자 유형 | 접근 가능 여부 |
|------------|---------------|
| OPERATOR (접수자) | 가능 |
| ANALYST (분석가) | 가능 |
| MANAGER (매니저) | 가능 |
| ADMIN (관리자) | 가능 |

---

## 3. 레이아웃 구조

```
┌─────────────────────────────────────────────────────────────┐
│  Sidebar  │  VOC 등록                                       │
│           ├─────────────────────────────────────────────────┤
│  Dashboard│                                                 │
│  VOC 입력 │  ① 고객 이메일 *                                │
│  VOC 목록 │  ┌─────────────────────────────────────────┐    │
│  칸반보드 │  │ customer@example.com                    │    │
│  ...      │  └─────────────────────────────────────────┘    │
│           │                                                 │
│           │  ┌─ ⚠ 미해결 VOC 경고 배너 ─────────────────┐  │
│           │  │ 이 고객의 미해결 VOC가 2건 있습니다       │  │
│           │  │ VOC-20260218-001  NEW  HIGH  결제 오류... │  │
│           │  └──────────────────────────────────────────┘  │
│           │                                                 │
│           │  ② 고객명                                      │
│           │  ┌─────────────────────────────────────────┐    │
│           │  │ 고객명을 입력하세요                      │    │
│           │  └─────────────────────────────────────────┘    │
│           │                                                 │
│           │  ③ 제목 *                                      │
│           │  ┌─────────────────────────────────────────┐    │
│           │  │ VOC 제목을 입력하세요 (2~200자)         │    │
│           │  └─────────────────────────────────────────┘    │
│           │                                                 │
│           │  ④ 내용 *                                      │
│           │  ┌─────────────────────────────────────────┐    │
│           │  │ 내용을 입력하세요 (최소 10자)            │    │
│           │  │                                         │    │
│           │  │                                         │    │
│           │  └─────────────────────────────────────────┘    │
│           │                                      0/5000     │
│           │                                                 │
│           │  ⑤ 카테고리 *                                  │
│           │  ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐           │
│           │  │ 🐛 │ │ 💡 │ │ ❓ │ │ ⚠️ │ │ 👍 │           │
│           │  │오류 │ │기능 │ │문의│ │불만 │ │칭찬 │           │
│           │  │/버그│ │요청 │ │    │ │/컴플│ │/감사│           │
│           │  └────┘ └────┘ └────┘ └────┘ └────┘           │
│           │  ※ AI가 자동 하이라이트 (EXAONE 3.5)           │
│           │                                                 │
│           │  중분류 *                                       │
│           │  ┌─────────────────────────────────────────┐    │
│           │  │ 중분류를 선택하세요              ▼      │    │
│           │  └─────────────────────────────────────────┘    │
│           │                                                 │
│           │  ⑥ 우선순위 *                                  │
│           │  ┌─────────────────────────────────────────┐    │
│           │  │ HIGH                            ▼      │    │
│           │  └─────────────────────────────────────────┘    │
│           │  [추천: 높음] ← AI 자동 추천 뱃지              │
│           │                                                 │
│           │  ────────────────────────────────────           │
│           │  ⑦ 📎 파일을 드래그하거나 클릭하여 업로드      │
│           │     최대 5개, 각 10MB 이하                      │
│           │  ────────────────────────────────────           │
│           │                                                 │
│           │  ✓ 임시저장됨 14:35    [초기화] [VOC 등록]     │
│           │                                                 │
│           │  ┌─ 안내 사항 ──────────────────────────────┐  │
│           │  │ • 등록된 VOC는 담당자 배정 후 처리됩니다  │  │
│           │  │ • 접수번호로 처리 현황 조회 가능          │  │
│           │  │ • 긴급 시 우선순위를 '긴급'으로 설정      │  │
│           │  │ • 첨부파일 최대 5개, 각 10MB까지          │  │
│           │  └──────────────────────────────────────────┘  │
│           │                                                 │
└───────────┴─────────────────────────────────────────────────┘
```

---

## 4. UI 요소 목록

### 4.1 입력 필드

| 순서 | 필드명 | 필드 타입 | 필수 | 설명 | 제약사항 |
|------|--------|----------|------|------|----------|
| ① | 고객 이메일 | text (email) | 필수 | Email-First 게이트 필드 (최상단) | 이메일 형식, 입력 즉시 이력 조회 |
| - | 미해결 VOC 배너 | banner | - | 고객의 NEW/IN_PROGRESS/PENDING VOC 표시 | 조건부 표시 (미해결 VOC 존재 시) |
| ② | 고객명 | text | 선택 | 최종 사용자 이름 | 최대 100자 |
| ③ | 제목 | text | 필수 | VOC 제목 | 2~200자 |
| ④ | 내용 | textarea | 필수 | VOC 상세 내용 | 최소 10자, 최대 5,000자 |
| ⑤ | 카테고리 | card grid | 필수 | 5대 대분류 카드 선택 → AI 자동 하이라이트 | 선택 후 중분류 드롭다운 표시 |
| - | 중분류 | select | 필수 | 대분류 선택 후 표시 (Progressive Disclosure) | 대분류에 따라 옵션 변경 |
| ⑥ | 우선순위 | select | 필수 | AI 자동 추천 + 수동 변경 가능 | LOW/MEDIUM/HIGH/URGENT |
| ⑦ | 첨부파일 | file (multiple) | 선택 | 드래그앤드롭 업로드 | 최대 5개, 각 10MB |

### 4.2 카테고리 카드 (5대 대분류)

| 카드 | 아이콘 | 설명 | 테두리 색상 | 배경 색상 |
|------|--------|------|------------|----------|
| 오류/버그 | 🐛 | 시스템 오류 및 버그 | #ef4444 | #fef2f2 |
| 기능 요청 | 💡 | 새 기능 및 개선 | #3b82f6 | #eff6ff |
| 문의 | ❓ | 사용법, 정책 등 | #22c55e | #f0fdf4 |
| 불만/컴플레인 | ⚠️ | 서비스 불만 및 민원 | #f59e0b | #fffbeb |
| 칭찬/감사 | 👍 | 만족 및 감사 피드백 | #a855f7 | #faf5ff |

### 4.3 AI 추천 동작

| 기능 | 트리거 | 동작 | 기술 |
|------|--------|------|------|
| 카테고리 추천 | 제목+내용 입력 (1초 디바운스) | 카드 자동 하이라이트 | EXAONE 3.5 (7.8B) Few-shot |
| 우선순위 추천 | 카테고리 선택 시 | 추천 뱃지 표시 | 카테고리 기본값 + 긴급키워드 매칭 |
| 우선순위 에스컬레이션 | ERROR + 긴급키워드 감지 | URGENT로 자동 상향 | 결제/장애/접속불가 등 키워드 |

### 4.4 임시저장

| 항목 | 동작 |
|------|------|
| 저장 주기 | 2초 디바운스 자동 저장 |
| 저장 대상 | PII 제외 (이메일, 고객명 제외) |
| 저장 위치 | localStorage |
| 만료 | 24시간 TTL |
| 상태 표시 | "✓ 임시저장됨 14:35" (하단 좌측) |

### 4.5 버튼

| 버튼명 | 스타일 | 기능 | 활성화 조건 |
|--------|--------|------|------------|
| 초기화 | secondary | 폼 초기화 + 임시저장 삭제 | 항상 활성화 |
| VOC 등록 | primary | VOC 접수 완료 및 Ticket ID 발급 | 필수 필드 입력 완료 시 |

### 4.6 첨부파일 제약사항

| 항목 | 제한 | 설명 |
|------|------|------|
| 최대 용량 | 파일당 10MB | 용량 초과 시 업로드 차단 |
| 최대 개수 | 5개 | 개수 초과 시 업로드 차단 |
| 허용 확장자 | jpg, png, gif, pdf, txt, log, zip | 화이트리스트 방식 검증 |
| 보안 검사 | MIME 타입 검증 | 업로드 시 MIME 타입 확인 |

---

## 5. 사용자 액션 및 이벤트

### 5.1 Email-First 게이트 (고객 이력 조회)

```
사용자 액션: 고객 이메일 입력
            ↓
시스템 처리: 1. 이메일 형식 검증 (실시간)
            2. SHA-256 해시로 변환
            3. GET /api/vocs?customerEmail={email} 호출
            ↓
조회 결과:
  - 미해결 VOC 존재 → amber 경고 배너 표시
    (VOC ID, 상태 뱃지, 우선순위 뱃지, 제목)
  - 미해결 VOC 없음 → 배너 숨김
  - 고객명 자동 완성 (이전 VOC의 customerName)
```

### 5.2 AI 카테고리 추천

```
사용자 액션: 제목 또는 내용 입력
            ↓
프론트엔드:  1초 디바운스 후 트리거 (제목 2자+ 또는 내용 10자+)
            ↓
API 호출:   POST /api/vocs/suggest-category
            Body: { "title": "...", "content": "..." }
            ↓
AI 처리:    EXAONE 3.5 LLM이 Few-shot Prompting으로 카테고리 분류
            (5개 실제 VOC 예시 포함, <user_input> 태그로 인젝션 방지)
            ↓
응답:       { "categoryCode": "ERROR", "confidence": 0.85 }
            ↓
UI 반영:    1. 해당 카테고리 카드 하이라이트 (테두리 2px + 배경색)
            2. 우선순위 자동 추천 갱신
```

### 5.3 우선순위 자동 추천

```
트리거: 카테고리 변경 시 (AI 추천 또는 수동 선택)
            ↓
로직:     1. CATEGORY_PRIORITY_MAP에서 기본 우선순위 조회
             - ERROR → HIGH
             - FEATURE → MEDIUM
             - INQUIRY → LOW
             - COMPLAINT → HIGH
             - PRAISE → LOW
          2. 긴급 키워드 감지 (결제, 장애, 접속불가 등)
             - ERROR + 긴급키워드 → URGENT 에스컬레이션
            ↓
UI 반영:  [추천: 높음] 뱃지 표시 + 우선순위 셀렉트 자동 변경
```

### 5.4 VOC 등록

```
사용자 액션: VOC 등록 버튼 클릭
            ↓
클라이언트 검증: 1. 필수 필드 입력 여부 확인
                2. 이메일 형식 검증
                3. 제목 길이 (2~200자)
                4. 내용 길이 (10~5000자)
                5. 카테고리/중분류 선택 여부
                6. 우선순위 선택 여부
                ↓
서버 제출: POST /api/vocs (201 Created)
            ↓
서버 처리: 1. 고객 이메일 AES-GCM 암호화 저장
          2. 이메일 SHA-256 해시 저장 (검색용)
          3. DB 저장 (상태: NEW)
          4. Ticket ID 발급 (형식: VOC-YYYYMMDD-XXXXX)
          5. @Async AI 분석 트리거:
             - Fallback Chain: ① RAG → ② Rule-Based → ③ Direct LLM
             - 감성 분석 (EXAONE 3.5)
             - VOC 임베딩 생성 (BGE-M3, 1024차원) → pgvector 저장
            ↓
성공 응답: 1. "VOC 입력이 완료되었습니다" 팝업
          2. Ticket ID 표시
          3. 폼 초기화
          4. 임시저장 삭제
```

### 5.5 임시저장

```
트리거: 폼 필드 변경 후 2초 경과 (디바운스)
            ↓
시스템 처리: 1. PII 필드 제외 (이메일, 고객명)
            2. localStorage에 JSON 저장
            3. 24시간 TTL 설정
            4. "✓ 임시저장됨 HH:MM" 상태 표시
            ↓
재접속 시: 임시저장 데이터 자동 복원
```

---

## 6. 유효성 검사

### 6.1 클라이언트 검증 (실시간)

| 필드 | 검증 규칙 | 에러 메시지 |
|------|----------|------------|
| 고객 이메일 | 1. 필수 입력<br>2. 이메일 형식 (RFC 5322) | "이메일을 입력해주세요"<br>"올바른 이메일 형식이 아닙니다" |
| 제목 | 1. 필수 입력<br>2. 2~200자 | "제목을 입력해주세요"<br>"제목은 2~200자로 입력해주세요" |
| 내용 | 1. 필수 입력<br>2. 10~5,000자 | "내용을 입력해주세요"<br>"내용은 최소 10자 이상 입력해주세요" |
| 카테고리 | 필수 선택 (대분류 + 중분류) | "카테고리를 선택해주세요" |
| 우선순위 | 필수 선택 | "우선순위를 선택해주세요" |
| 첨부파일 | 1. 최대 5개<br>2. 파일당 10MB<br>3. 허용 확장자만 | "최대 5개까지 업로드 가능합니다"<br>"파일 용량이 초과되었습니다"<br>"허용되지 않는 파일 형식입니다" |

### 6.2 서버 검증

| 검증 항목 | 검증 로직 | 실패 시 처리 |
|----------|----------|-------------|
| Rate Limiting | 동일 사용자 분당 10건 제한 | HTTP 429 (Too Many Requests) |
| XSS Sanitization | 모든 텍스트 입력값 sanitization | 악성 스크립트 제거 후 저장 |
| 이메일 형식 | RFC 5322 준수 여부 | HTTP 400 (Bad Request) |
| 데이터 길이 | DB 컬럼 길이 제한 준수 | HTTP 400 (Bad Request) |

---

## 7. 에러 처리

### 7.1 클라이언트 에러

| 에러 시나리오 | 에러 메시지 | 처리 방법 |
|-------------|------------|----------|
| 필수 필드 미입력 | "필수 항목을 입력해주세요" | 해당 필드 하이라이트 및 포커스 이동 |
| 이메일 형식 오류 | "올바른 이메일 형식이 아닙니다" | 이메일 필드 하이라이트 |
| 고객 이력 조회 실패 | - (silent fail) | 배너 미표시, 폼 입력 계속 가능 |
| AI 카테고리 추천 실패 | - (silent fail) | 수동 카테고리 선택으로 폴백 |
| 파일 용량 초과 | "파일 용량이 초과되었습니다 (최대 10MB)" | 파일 업로드 차단 |

### 7.2 서버 에러

| HTTP 상태 코드 | 에러 시나리오 | 에러 메시지 | 처리 방법 |
|---------------|-------------|------------|----------|
| 400 | 유효성 검사 실패 | "입력 데이터가 올바르지 않습니다" | 서버 응답의 상세 메시지 표시 |
| 429 | Rate Limiting 초과 | "요청이 너무 많습니다. 잠시 후 다시 시도해주세요" | 제출 버튼 비활성화 (1분) |
| 500 | 서버 내부 오류 | "서버 오류가 발생했습니다" | 에러 메시지 표시 및 재시도 안내 |

---

## 8. 연관 API

### 8.1 고객 VOC 이력 조회

```
GET /api/vocs?customerEmail={email}

Response (성공):
HTTP 200 OK
{
  "content": [
    {
      "id": 1,
      "vocNumber": "VOC-20260218-001",
      "title": "결제 오류가 발생하고 있습니다",
      "status": "NEW",
      "priority": "HIGH",
      "customerName": "홍길동",
      "createdAt": "2026-02-18T10:00:00Z"
    }
  ],
  "totalElements": 2
}

※ 서버에서 customerEmail을 SHA-256 해시로 비교하여 검색
```

### 8.2 AI 카테고리 추천

```
POST /api/vocs/suggest-category
Content-Type: application/json

Request Body:
{
  "title": "결제가 안됩니다",
  "content": "카드 결제 시 오류가 발생합니다"
}

Response (성공):
HTTP 200 OK
{
  "categoryCode": "ERROR",
  "confidence": 0.85
}
```

### 8.3 VOC 등록

```
POST /api/vocs
Content-Type: application/json

Request Body:
{
  "customerEmail": "user@example.com",
  "customerName": "홍길동",
  "title": "VOC 제목",
  "content": "VOC 상세 내용",
  "categoryId": 1,
  "priority": "HIGH"
}

Response (성공):
HTTP 201 Created
{
  "id": 1,
  "vocNumber": "VOC-20260218-00001",
  "status": "NEW",
  "createdAt": "2026-02-18T14:35:00Z"
}
```

---

## 9. 화면 전환

### 9.1 진입 경로

| 이전 화면 | 전환 조건 |
|----------|----------|
| SC-01 로그인 | 로그인 성공 후 사이드바에서 "VOC 입력" 선택 |
| SC-03 대시보드 | 사이드바에서 "VOC 입력" 선택 |
| SC-06 VOC 상세 | "새 VOC 등록" 버튼 클릭 |

### 9.2 이탈 경로

| 다음 화면 | 전환 조건 |
|----------|----------|
| 현재 화면 유지 | VOC 등록 성공 후 팝업 닫기 (폼 초기화) |
| SC-04 VOC 목록 | VOC 등록 성공 팝업에서 "목록 보기" 클릭 |
| SC-06 VOC 상세 | VOC 등록 성공 팝업에서 "상세 보기" 클릭 |

---

## 10. 접근성 (Accessibility)

### 10.1 키보드 네비게이션

| 키 | 동작 |
|----|------|
| Tab | 다음 입력 필드로 포커스 이동 |
| Shift + Tab | 이전 입력 필드로 포커스 이동 |
| Enter | 카테고리 카드 선택 (포커스 시) |
| Space | 카테고리 카드 선택 (포커스 시) |
| Esc | 팝업 닫기 |

### 10.2 ARIA 속성

| 요소 | ARIA 속성 | 값 |
|------|----------|-----|
| 필수 필드 | aria-required | true |
| 에러 메시지 | role | alert |
| 카테고리 카드 그리드 | role | radiogroup |
| 카테고리 카드 | role | radio |
| AI 추천 뱃지 | aria-live | polite |
| 미해결 VOC 배너 | role | alert |

---

## 11. 보안 고려사항

### 11.1 개인정보 보호
- 고객 이메일: AES-GCM 암호화 저장 (DB)
- 고객 이메일 해시: SHA-256 (검색용, 별도 컬럼)
- 임시저장: PII 제외 (이메일, 고객명 미포함)

### 11.2 XSS 방지
- 모든 텍스트 입력값 서버 sanitization
- HTML 태그, JavaScript 코드 제거

### 11.3 Rate Limiting
- 동일 사용자(로그인 계정 기준) 분당 10건 제한
- 제한 초과 시 1분간 제출 차단

### 11.4 AI 프롬프트 인젝션 방지
- 사용자 입력을 `<user_input>` 태그로 감싸 LLM 프롬프트와 분리
- Few-shot 예시는 시스템 프롬프트에 포함 (사용자 조작 불가)

---

## 12. 성능 고려사항

| 항목 | 목표 | 구현 방식 |
|------|------|----------|
| VOC 등록 API | 3초 이내 | Ticket ID 동기 발급, AI 분석은 @Async |
| 카테고리 추천 | 2초 이내 | EXAONE 3.5 로컬 추론 (Ollama) |
| 고객 이력 조회 | 1초 이내 | SHA-256 해시 인덱스 검색 |
| 디바운싱 | - | 카테고리 추천 1초, 임시저장 2초 |

---

## 13. 프론트엔드 구현

### 13.1 컴포넌트 구조

```
/voc/input/page.tsx
├── VocForm.tsx                    # 폼 컨테이너 (MVVM View)
│   ├── CustomerVocHistoryBanner   # 미해결 VOC 경고 배너
│   ├── CategoryCardSelect         # 5대 대분류 카드 그리드
│   └── PriorityRecommendation     # AI 우선순위 추천 뱃지
└── hooks/
    ├── useVocFormViewModel.ts     # 폼 비즈니스 로직 (ViewModel)
    └── useCustomerVocHistory.ts   # 고객 이력 조회 훅
```

### 13.2 기술 스택

- React + TypeScript
- React Hook Form + Zod (폼 관리 및 유효성 검사)
- TanStack Query (API 호출)
- MVVM ViewModel 패턴 (비즈니스 로직 분리)

---

## 14. 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|----------|--------|
| 1.0 | 2026-01-23 | 최초 작성 | Claude Code |
| 2.0 | 2026-02-18 | PLAN-005 반영: Email-First 게이트, 카테고리 카드 UI, AI 추천, 임시저장 | Claude Code |
