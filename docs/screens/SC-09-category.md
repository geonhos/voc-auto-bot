# SC-09 카테고리 관리 화면 정의

## 1. 개요

### 1.1 화면 목적
관리자가 VOC 카테고리를 생성, 수정, 삭제할 수 있는 관리 화면입니다. 계층 구조(대분류 > 중분류)를 지원하며, DB 기반으로 카테고리를 관리합니다.

### 1.2 관련 요구사항
- FR-501: 관리자는 VOC 카테고리를 생성/수정/삭제할 수 있다
- FR-502: 카테고리는 DB에서 관리한다 (코드 하드코딩 금지)
- FR-503: 카테고리는 계층 구조를 가질 수 있다 (대분류 > 중분류)
- FR-1002: 카테고리 수정 시 변경 이력을 저장한다

### 1.3 접근 권한
- 관리자만 접근 가능
- 비인가 사용자 접근 시 로그인 화면으로 리다이렉트

### 1.4 연관 이슈
- #9

---

## 2. 레이아웃 구조

### 2.1 전체 레이아웃

```
┌─────────────────────────────────────────────────────────────┐
│ Header (공통)                                                │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌─────────────────┐  ┌──────────────────────────────┐      │
│  │                 │  │                              │      │
│  │  카테고리 트리   │  │    카테고리 상세 폼           │      │
│  │                 │  │                              │      │
│  │  - 대분류 1     │  │  [카테고리 이름]              │      │
│  │    - 중분류 1-1 │  │  [계층 선택]                  │      │
│  │    - 중분류 1-2 │  │  [정렬 순서]                  │      │
│  │  - 대분류 2     │  │  [활성 여부]                  │      │
│  │    - 중분류 2-1 │  │                              │      │
│  │                 │  │  [저장] [취소] [삭제]         │      │
│  │  [+ 대분류 추가] │  │                              │      │
│  │                 │  │                              │      │
│  └─────────────────┘  └──────────────────────────────┘      │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 반응형 레이아웃
- 데스크톱: 좌우 분할 (카테고리 트리 30% | 상세 폼 70%)
- 태블릿: 좌우 분할 유지
- 모바일: 상하 분할 (트리 → 상세 순서)

---

## 3. UI 요소 목록

### 3.1 카테고리 트리 영역

#### 3.1.1 트리 구조
| 요소 | 설명 | 상호작용 |
|------|------|---------|
| 대분류 노드 | 루트 레벨 카테고리 표시 | 클릭 시 상세 폼에 로드 |
| 중분류 노드 | 대분류 하위 카테고리 표시 | 클릭 시 상세 폼에 로드 |
| 펼침/접기 아이콘 | 대분류 노드 좌측에 표시 | 클릭 시 하위 노드 토글 |
| 선택 강조 | 현재 선택된 노드 강조 표시 | - |

#### 3.1.2 액션 버튼
| 버튼 | 설명 | 동작 |
|------|------|------|
| [+ 대분류 추가] | 새 대분류 카테고리 추가 | 빈 폼 표시 (계층: 대분류 고정) |
| [+ 중분류 추가] | 선택된 대분류 하위에 중분류 추가 | 빈 폼 표시 (계층: 중분류, 부모: 선택된 대분류) |

### 3.2 카테고리 상세 폼

#### 3.2.1 입력 필드
| 필드명 | 타입 | 필수 | 제약사항 | 설명 |
|--------|------|------|---------|------|
| 카테고리 이름 | Text | O | 최대 50자, 중복 불가 | 카테고리 표시명 |
| 계층 | Select | O | 대분류/중분류 | 카테고리 레벨 |
| 상위 카테고리 | Select | 조건부 | 중분류일 때 필수 | 대분류 목록에서 선택 |
| 정렬 순서 | Number | O | 1 이상 정수 | 동일 레벨 내 표시 순서 |
| 활성 여부 | Checkbox | - | - | 비활성 시 VOC 분류 시 사용 불가 |
| 설명 | Textarea | X | 최대 200자 | 카테고리 설명 (선택) |

#### 3.2.2 액션 버튼
| 버튼 | 표시 조건 | 동작 |
|------|---------|------|
| [저장] | 항상 표시 | 입력 값 유효성 검사 후 저장 |
| [취소] | 항상 표시 | 폼 초기화, 선택 해제 |
| [삭제] | 기존 카테고리 수정 시 | 삭제 확인 다이얼로그 표시 |

---

## 4. 사용자 액션 및 이벤트

### 4.1 카테고리 추가

#### 4.1.1 대분류 추가
1. [+ 대분류 추가] 버튼 클릭
2. 우측 폼에 빈 입력 필드 표시
   - 계층: "대분류" 고정 (비활성화)
   - 상위 카테고리: 숨김
3. 필수 필드 입력
4. [저장] 버튼 클릭
5. 유효성 검사 통과 시 DB 저장
6. 트리에 새 노드 추가, 성공 토스트 표시

#### 4.1.2 중분류 추가
1. 트리에서 대분류 선택
2. [+ 중분류 추가] 버튼 클릭 (대분류 선택 시에만 활성화)
3. 우측 폼에 빈 입력 필드 표시
   - 계층: "중분류" 고정 (비활성화)
   - 상위 카테고리: 선택된 대분류로 자동 설정
4. 필수 필드 입력
5. [저장] 버튼 클릭
6. 유효성 검사 통과 시 DB 저장
7. 트리에 새 하위 노드 추가, 성공 토스트 표시

### 4.2 카테고리 수정

1. 트리에서 수정할 카테고리 선택
2. 우측 폼에 기존 데이터 로드
3. 필드 수정
4. [저장] 버튼 클릭
5. 유효성 검사 통과 시 DB 업데이트
6. 변경 이력 저장 (Audit Log)
7. 트리 갱신, 성공 토스트 표시

### 4.3 카테고리 삭제

1. 트리에서 삭제할 카테고리 선택
2. [삭제] 버튼 클릭
3. 확인 다이얼로그 표시
   - 메시지: "이 카테고리를 삭제하시겠습니까?"
   - 하위 카테고리 존재 시: "하위 카테고리가 존재합니다. 함께 삭제됩니다."
   - VOC 사용 중 시: "이미 사용 중인 카테고리입니다. 삭제 시 해당 VOC의 카테고리가 '미분류'로 변경됩니다."
4. [확인] 클릭 시 삭제 수행
5. DB에서 삭제 (CASCADE 또는 NULL 처리)
6. 트리에서 노드 제거, 성공 토스트 표시

### 4.4 카테고리 활성/비활성

1. 트리에서 카테고리 선택
2. 우측 폼에서 "활성 여부" 체크박스 토글
3. [저장] 버튼 클릭
4. DB 업데이트
5. 트리에서 비활성 노드 시각적으로 구분 (회색 처리, 이탤릭 등)

---

## 5. 유효성 검사

### 5.1 필드별 검증 규칙

| 필드 | 검증 규칙 | 에러 메시지 |
|------|---------|-----------|
| 카테고리 이름 | 필수 입력 | "카테고리 이름을 입력해주세요" |
| 카테고리 이름 | 최대 50자 | "카테고리 이름은 최대 50자까지 입력 가능합니다" |
| 카테고리 이름 | 중복 검사 (동일 레벨 내) | "이미 존재하는 카테고리 이름입니다" |
| 계층 | 필수 선택 | "계층을 선택해주세요" |
| 상위 카테고리 | 중분류일 때 필수 | "상위 카테고리를 선택해주세요" |
| 정렬 순서 | 필수 입력 | "정렬 순서를 입력해주세요" |
| 정렬 순서 | 1 이상 정수 | "정렬 순서는 1 이상의 정수여야 합니다" |
| 설명 | 최대 200자 | "설명은 최대 200자까지 입력 가능합니다" |

### 5.2 비즈니스 규칙 검증

| 규칙 | 조건 | 에러 메시지 |
|------|------|-----------|
| 계층 제한 | 최대 2단계까지만 허용 | "카테고리는 최대 2단계(대분류 > 중분류)까지 생성 가능합니다" |
| 하위 존재 시 삭제 차단 | 하위 카테고리 존재 시 삭제 불가 옵션 적용 시 | "하위 카테고리가 존재하여 삭제할 수 없습니다. 먼저 하위 카테고리를 삭제해주세요" |
| 사용 중인 카테고리 삭제 | VOC에서 사용 중인 카테고리 삭제 시 경고 | "이미 {count}건의 VOC에서 사용 중입니다. 삭제하시겠습니까?" |

---

## 6. 에러 처리

### 6.1 에러 유형 및 처리

| 에러 유형 | 원인 | 처리 방법 | 사용자 메시지 |
|----------|------|---------|-------------|
| 네트워크 에러 | API 호출 실패 | 에러 토스트 표시, 재시도 버튼 제공 | "네트워크 오류가 발생했습니다. 다시 시도해주세요" |
| 권한 에러 | 관리자 권한 없음 | 로그인 화면으로 리다이렉트 | "접근 권한이 없습니다" |
| 유효성 검증 실패 | 입력 값 검증 실패 | 해당 필드 하단에 에러 메시지 표시 | 필드별 에러 메시지 (위 표 참조) |
| DB 제약 조건 위반 | 중복 이름 등 | 에러 토스트 표시 | "이미 존재하는 카테고리 이름입니다" |
| 삭제 제약 조건 위반 | 참조 무결성 제약 | 확인 다이얼로그 표시 | "하위 카테고리 또는 사용 중인 VOC가 존재합니다" |
| 서버 에러 (500) | 서버 내부 오류 | 에러 모달 표시, 관리자 문의 안내 | "시스템 오류가 발생했습니다. 관리자에게 문의해주세요" |

### 6.2 에러 표시 위치

- 필드 검증 에러: 해당 입력 필드 하단에 빨간색 텍스트
- API 호출 에러: 화면 상단 토스트 메시지
- 삭제 확인/경고: 모달 다이얼로그
- 치명적 에러: 전체 화면 에러 바운더리

---

## 7. 연관 API

### 7.1 카테고리 API 목록

| API | HTTP Method | Endpoint | 설명 |
|-----|-------------|----------|------|
| 카테고리 목록 조회 | GET | `/api/admin/categories` | 전체 카테고리 트리 조회 |
| 카테고리 상세 조회 | GET | `/api/admin/categories/{id}` | 특정 카테고리 상세 조회 |
| 카테고리 생성 | POST | `/api/admin/categories` | 새 카테고리 생성 |
| 카테고리 수정 | PUT | `/api/admin/categories/{id}` | 기존 카테고리 수정 |
| 카테고리 삭제 | DELETE | `/api/admin/categories/{id}` | 카테고리 삭제 |
| 이름 중복 검사 | GET | `/api/admin/categories/validate-name?name={name}&parentId={parentId}` | 카테고리 이름 중복 검사 |
| 사용 현황 조회 | GET | `/api/admin/categories/{id}/usage` | 카테고리 사용 중인 VOC 수 조회 |

### 7.2 요청/응답 예시

#### 7.2.1 카테고리 생성 (POST `/api/admin/categories`)

**요청**
```json
{
  "name": "시스템 오류",
  "level": "SUB",
  "parentId": 1,
  "sortOrder": 1,
  "isActive": true,
  "description": "시스템 동작 중 발생한 오류"
}
```

**응답**
```json
{
  "id": 10,
  "name": "시스템 오류",
  "level": "SUB",
  "parentId": 1,
  "parentName": "오류/버그",
  "sortOrder": 1,
  "isActive": true,
  "description": "시스템 동작 중 발생한 오류",
  "createdAt": "2026-01-23T10:00:00Z",
  "createdBy": "admin@example.com",
  "updatedAt": "2026-01-23T10:00:00Z",
  "updatedBy": "admin@example.com"
}
```

#### 7.2.2 카테고리 목록 조회 (GET `/api/admin/categories`)

**응답**
```json
{
  "categories": [
    {
      "id": 1,
      "name": "오류/버그",
      "level": "MAIN",
      "parentId": null,
      "sortOrder": 1,
      "isActive": true,
      "children": [
        {
          "id": 10,
          "name": "시스템 오류",
          "level": "SUB",
          "parentId": 1,
          "sortOrder": 1,
          "isActive": true,
          "children": []
        }
      ]
    }
  ]
}
```

---

## 8. 화면 전환

### 8.1 진입 경로

| 이전 화면 | 전환 트리거 | 전환 방식 |
|----------|-----------|---------|
| 관리자 대시보드 | 좌측 메뉴 "카테고리 관리" 클릭 | 화면 전환 |
| 사용자 관리 화면 | 좌측 메뉴 "카테고리 관리" 클릭 | 화면 전환 |

### 8.2 종료 경로

| 다음 화면 | 전환 트리거 | 전환 방식 |
|----------|-----------|---------|
| 관리자 대시보드 | 좌측 메뉴 "대시보드" 클릭 | 화면 전환 |
| 사용자 관리 화면 | 좌측 메뉴 "사용자 관리" 클릭 | 화면 전환 |
| 로그인 화면 | 권한 없음 / 세션 만료 | 리다이렉트 |

### 8.3 화면 전환 시 처리

- 미저장 변경사항 있을 경우 확인 다이얼로그 표시
  - 메시지: "저장하지 않은 변경사항이 있습니다. 페이지를 떠나시겠습니까?"
  - [취소] / [떠나기] 버튼 제공

---

## 9. 상태 관리

### 9.1 로컬 상태

| 상태 | 설명 | 초기값 |
|------|------|-------|
| selectedCategory | 현재 선택된 카테고리 | null |
| expandedNodes | 트리에서 펼쳐진 노드 ID 목록 | [] |
| formMode | 폼 모드 ('create' \| 'edit' \| 'idle') | 'idle' |
| formData | 폼 입력 데이터 | {} |
| isSubmitting | 저장 중 여부 | false |

### 9.2 서버 상태 (TanStack Query)

| Query Key | 설명 | 캐싱 시간 |
|-----------|------|---------|
| ['categories'] | 전체 카테고리 트리 | 5분 |
| ['category', id] | 특정 카테고리 상세 | 5분 |

### 9.3 낙관적 업데이트

- 카테고리 추가/수정/삭제 시 즉시 UI 업데이트
- API 호출 실패 시 롤백 처리
- 성공 시 서버 응답으로 최종 확정

---

## 10. 접근성 (Accessibility)

### 10.1 키보드 네비게이션

| 키 | 동작 |
|----|------|
| Tab | 포커스 이동 (트리 → 폼 필드 → 버튼) |
| Enter | 선택된 트리 노드 활성화 / 폼 제출 |
| Arrow Up/Down | 트리 노드 간 이동 |
| Arrow Left/Right | 트리 노드 펼침/접기 |
| Esc | 다이얼로그 닫기 / 폼 취소 |

### 10.2 ARIA 속성

- 트리: `role="tree"`, `aria-label="카테고리 트리"`
- 트리 노드: `role="treeitem"`, `aria-expanded`, `aria-selected`
- 폼 필드: `aria-label`, `aria-required`, `aria-invalid`, `aria-describedby`
- 에러 메시지: `role="alert"`

### 10.3 스크린 리더 지원

- 폼 필드 레이블 명확히 제공
- 에러 메시지 즉시 읽기
- 트리 노드 상태 변경 시 알림

---

## 11. 성능 최적화

### 11.1 최적화 전략

- 카테고리 트리 가상 스크롤 (100개 이상 시)
- 트리 노드 컴포넌트 메모이제이션
- 폼 입력 디바운싱 (이름 중복 검사)
- 이미지/아이콘 레이지 로딩

### 11.2 로딩 상태

- 초기 로딩: 스켈레톤 UI 표시
- 저장 중: 버튼 비활성화 + 스피너
- 삭제 중: 버튼 비활성화 + 스피너

---

## 12. 테스트 시나리오

### 12.1 기능 테스트

| 시나리오 | 검증 항목 |
|---------|---------|
| 대분류 추가 | 트리에 새 노드 추가, DB 저장 확인 |
| 중분류 추가 | 선택된 대분류 하위에 노드 추가, DB 저장 확인 |
| 카테고리 수정 | 트리 및 폼 데이터 갱신, Audit Log 저장 확인 |
| 카테고리 삭제 | 트리에서 노드 제거, DB 삭제 확인, CASCADE 처리 확인 |
| 이름 중복 검사 | 동일 레벨 내 중복 시 에러 표시 |
| 비활성화 | 트리에서 시각적 구분, VOC 분류 시 미노출 확인 |

### 12.2 에러 처리 테스트

| 시나리오 | 검증 항목 |
|---------|---------|
| 필수 필드 미입력 | 필드별 에러 메시지 표시 |
| 네트워크 에러 | 토스트 메시지 표시, 재시도 가능 |
| 권한 없음 | 로그인 화면으로 리다이렉트 |
| 하위 카테고리 존재 시 삭제 | 확인 다이얼로그 표시 |

### 12.3 접근성 테스트

| 시나리오 | 검증 항목 |
|---------|---------|
| 키보드 네비게이션 | Tab, Enter, Arrow 키로 모든 기능 접근 가능 |
| 스크린 리더 | 폼 필드 레이블, 에러 메시지 읽기 |
| 포커스 관리 | 모달 열림/닫힘 시 포커스 이동 |

---

## 13. 기술 스택 (프론트엔드)

| 항목 | 기술 |
|------|------|
| Framework | React 18+ |
| Language | TypeScript 5+ |
| State Management | TanStack Query (서버 상태), Zustand (로컬 상태) |
| UI Library | Headless UI, Radix UI (Tree, Dialog) |
| Form | React Hook Form + Zod |
| Styling | Tailwind CSS |
| Icons | Heroicons, Lucide React |

---

## 14. 변경 이력

| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|---------|
| 1.0 | 2026-01-23 | Claude Code | 초안 작성 |
